<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>scripts.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Chess3d.html">Chess3d</a><ul class='methods'><li data-type='method'><a href="Chess3d.html#.render">render</a></li><li data-type='method'><a href="Chess3d.html#clearBoard">clearBoard</a></li><li data-type='method'><a href="Chess3d.html#createBishops">createBishops</a></li><li data-type='method'><a href="Chess3d.html#createBoard">createBoard</a></li><li data-type='method'><a href="Chess3d.html#createCamera">createCamera</a></li><li data-type='method'><a href="Chess3d.html#createChess">createChess</a></li><li data-type='method'><a href="Chess3d.html#createKings">createKings</a></li><li data-type='method'><a href="Chess3d.html#createKnights">createKnights</a></li><li data-type='method'><a href="Chess3d.html#createLights">createLights</a></li><li data-type='method'><a href="Chess3d.html#createPawns">createPawns</a></li><li data-type='method'><a href="Chess3d.html#createQueens">createQueens</a></li><li data-type='method'><a href="Chess3d.html#createRenderer">createRenderer</a></li><li data-type='method'><a href="Chess3d.html#createRooks">createRooks</a></li><li data-type='method'><a href="Chess3d.html#createScene">createScene</a></li><li data-type='method'><a href="Chess3d.html#getBoardCoord">getBoardCoord</a></li><li data-type='method'><a href="Chess3d.html#init">init</a></li><li data-type='method'><a href="Chess3d.html#loadModel">loadModel</a></li><li data-type='method'><a href="Chess3d.html#movePiece">movePiece</a></li><li data-type='method'><a href="Chess3d.html#resizeCanvas">resizeCanvas</a></li><li data-type='method'><a href="Chess3d.html#setPiece">setPiece</a></li><li data-type='method'><a href="Chess3d.html#start">start</a></li></ul></li><li><a href="ChessViewer.html">ChessViewer</a><ul class='methods'><li data-type='method'><a href="ChessViewer.html#.chess3d_ready">chess3d_ready</a></li><li data-type='method'><a href="ChessViewer.html#.get_pgn">get_pgn</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnDecreaseSpeed">on_btnDecreaseSpeed</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnIncreaseSpeed">on_btnIncreaseSpeed</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnNext">on_btnNext</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnPauseClick">on_btnPauseClick</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnPlayClick">on_btnPlayClick</a></li><li data-type='method'><a href="ChessViewer.html#.on_btnPrevious">on_btnPrevious</a></li><li data-type='method'><a href="ChessViewer.html#.on_gameSelection">on_gameSelection</a></li><li data-type='method'><a href="ChessViewer.html#.on_listClick">on_listClick</a></li><li data-type='method'><a href="ChessViewer.html#bakeChess">bakeChess</a></li><li data-type='method'><a href="ChessViewer.html#init">init</a></li><li data-type='method'><a href="ChessViewer.html#markActiveMove">markActiveMove</a></li><li data-type='method'><a href="ChessViewer.html#nextMove">nextMove</a></li><li data-type='method'><a href="ChessViewer.html#pauseChess">pauseChess</a></li><li data-type='method'><a href="ChessViewer.html#previousMove">previousMove</a></li><li data-type='method'><a href="ChessViewer.html#resumeChess">resumeChess</a></li><li data-type='method'><a href="ChessViewer.html#setSpeed">setSpeed</a></li><li data-type='method'><a href="ChessViewer.html#showMovesList">showMovesList</a></li><li data-type='method'><a href="ChessViewer.html#startChess">startChess</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">scripts.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>$(document).ready(function () {
    window.chessViewer = new ChessViewer();
    chessViewer.init();
});

(function(_global) {
    "use strict";

    /**
     * @class
     * @classdesc Mediante esta clase podremos controlar el flujo de una partida de ajedrez leída de un fichero pgn y mostrarla en un entorno 3D.
     * @this ChessViewer
     * @global
     * @return ChessViewer
     */
    function ChessViewer() {
        this.folder_games = "resources/";
        this.games_files = ["beliavsky_nunn_1985", "byrne_fischer_1956", "ivanchuk_yusupov_1991", "karpov_kasparov_1985", "rotlewi_rubinstein_1907"];
        this.title = '';
        this.boards = [];
        this.bakedBoard = [];
        this.currentTurn = 0;
        this.speed = 1000;
        this.timer = null;

        this.chess = undefined;

        //html elems
        this._select = undefined;
        this._canvas = undefined;
    }

    _global.ChessViewer = ChessViewer;

    /**
     * Inicia el visor
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.init = function () {
        //Get html elements
        this._select =  $("#game-selection");
        this._canvas = $("#canvas")[0];

        //init chess
        this.chess = new Chess();

        //fill select
        for (var i = 0; i &lt; this.games_files.length; i++) {
            $(this._select).append($("&lt;li id=" + this.games_files[i] + ">&lt;a href='#'>" + this.games_files[i] + "&lt;/li>"));
        }

        $(this._select).find("> li").click(on_gameSelection.bind(this));
        $('body').on('click', '#moves-list li', on_listClick.bind(this))
            .on('click', '#btn-play',     on_btnPlayClick.bind(this))
            .on('click', '#btn-pause',    on_btnPauseClick.bind(this))
            .on('click', '#btn-incSpeed', on_btnIncreaseSpeed.bind(this))
            .on('click', '#btn-decSpeed', on_btnDecreaseSpeed.bind(this))
            .on('click', '#btn-next',     on_btnNext.bind(this))
            .on('click', '#btn-previous', on_btnPrevious.bind(this));

        this.chess3d = new Chess3d(this._canvas);
        this.chess3d.on_ready = chess3d_ready.bind(this);
        this.chess3d.speed_anim = this.speed - 300;
        this.chess3d.init();
    };

    /**
     * Inicia el entorno 3D y el tablero en el turno 0 (estado inicial)
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.startChess = function () {
        this.chess3d.start();
        this.setChess(0);
        //this.resumeChess();

    };

    /**
     * Reaunuda la reproducción de la partida.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.resumeChess = function () {
        this.pauseChess();
        this.timer = setInterval(this.nextMove.bind(this), this.speed);
    };

    /**
     * Pausa la reproducción de la partida.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.pauseChess = function () {
        if(this.timer != null) clearInterval(this.timer);
        this.timer = null;
    };

    /**
     * Configura la velocidad de reproducción.
     * @param {number} speed - Nueva velocidad en ms, que es el tiempo dedicado a cada turno.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.setSpeed = function (speed) {
        this.speed = speed;
        this.chess3d.speed_anim = this.speed - 300;
        if(this.timer) {
            this.pauseChess();
            this.timer = setInterval(this.nextMove.bind(this), this.speed);
        }
    };

    /**
     * Rellena la lista de turnos
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.showMovesList = function() {
        var new_chess = new Chess();
        for (var i = 0; i &lt; this.chess.history().length; i++) {
            $("#moves-list").append($("&lt;li class='list-group-item' id='board-" + i + "'>&lt;a href='#'>" + this.chess.history()[i] + "&lt;/li>"));

            new_chess.move(this.chess.history()[i]);
            this.boards.push(new_chess.ascii());
        }
    };

    /**
     * A partir de la información de la partida, crea el estado completo de cada turno a lo largo de la partida, de forma que tenemos tableros completos, y no incrementales.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.bakeChess = function () {
        var history = this.chess.history({verbose: true});
        var bb = this.bakedBoard;
        bb.push(clone(initial_state));

        for(var i in history) {
            if(history.hasOwnProperty(i)) {
                var h = history[i];
                var last = bb.length - 1;

                //clone last turn state
                var t = clone(bb[last]);

                //fill current turn data
                t.data = {
                    from: h.from,
                    to: h.to,
                    color: h.color,
                    flags: h.flags,
                    moves: t[h.from],
                    captured: t[h.to],
                    promotion: h.promotion
                };

                //move piece
                t[h.to] = t[h.from];
                t[h.from] = null;

                //Castling
                if(h.flags == "k") {
                    if(h.color == "w") {
                        t.data.castling_from = "h1";
                        t.data.castling_to = "f1";
                        t.data.castling_moves = t["h1"];
                        t["f1"] = t["h1"];
                        t["h1"] = null;
                    }
                    else {
                        t.data.castling_from = "h8";
                        t.data.castling_to = "f8";
                        t.data.castling_moves = t["h8"];
                        t["f8"] = t["h8"];
                        t["h8"] = null;
                    }
                }
                else if (h.flags == "q") {
                    if(h.color == "w") {
                        t.data.castling_from = "aq";
                        t.data.castling_to = "d1";
                        t.data.castling_moves = t["a1"];
                        t["d1"] = t["a1"];
                        t["a1"] = null;
                    }
                    else {
                        t.data.castling_from = "a8";
                        t.data.castling_to = "d8";
                        t.data.castling_moves = t["a8"];
                        t["d8"] = t["a8"];
                        t["a8"] = null;
                    }
                }

                bb.push(t);
            }
        }
    };

    /**
     * Coloca el tablero en el estado de un determinado turno.
     * @param {number} turn - turno a colocar.
     */
    ChessViewer.prototype.setChess = function (turn) {
        this.chess3d.clearBoard();
        this.currentTurn = turn;
        this.markActiveMove();
        var board = this.bakedBoard[turn];
        for(var i in board) {
            if(i != "data" &amp;&amp; board.hasOwnProperty(i)) {
                var id = board[i];
                if(id != null) this.chess3d.setPiece(id, i);
            }
        }
    };

    /**
     * Coloca el tablero en el siguiente turno al actual.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.nextMove = function () {
        var length = this.bakedBoard.length - 1;
        if(this.currentTurn >= length) clearTimeout(this.timer);
        else {
            this.currentTurn++;
            this.markActiveMove();
            var board = this.bakedBoard[this.currentTurn];
            var data = board.data;
            if (data.moves &amp;&amp; data.from &amp;&amp; data.to) {
                this.chess3d.movePiece(data.moves, data.from, data.to, data.captured);
                if(data.castling_from &amp;&amp; data.castling_to)
                    this.chess3d.movePiece(data.castling_moves, data.castling_from, data.castling_to);
            }
        }
    };

    /**
     * Coloca el tablero en el anterior turno al actual
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.previousMove = function () {
        console.log("turn: " + this.currentTurn);
        if(this.currentTurn > 0) {
            var board = this.bakedBoard[this.currentTurn];
            var data = board.data;
            if (data.moves &amp;&amp; data.from &amp;&amp; data.to) {
                this.chess3d.movePiece(data.moves, data.to, data.from, data.captured, true);
                if(data.castling_from &amp;&amp; data.castling_to)
                    this.chess3d.movePiece(data.castling_moves, data.castling_to, data.castling_from);
            }

            this.currentTurn--;
            this.markActiveMove();
        }
    };

    /**
     * Señala en la lista de movimientos el turno actual
     * @this ChessViewer
     * @memberof ChessViewer
     */
    ChessViewer.prototype.markActiveMove = function(){
        var id = "#board-" + this.currentTurn;

        $(".list-group-item").removeClass("active");

        if(!$(id).hasClass("active"))
            $(id).addClass("active");

        if(this.currentTurn > 3){
            var turn_top = this.currentTurn-3;
            var id_top = "#board-" + turn_top;
            $("#div-moves").scrollTop($(id_top).offset().top - $("#board-0").offset().top);
        }       
    };

    /**
     * Carga un fichero pgn.
     * @this ChessViewer
     * @memberof ChessViewer
     * @param data
     */
    function get_pgn(data) {
        var pgn = data.split("\n");
        this.chess.load_pgn(pgn.join('\n'));
        this.showMovesList();
        this.bakeChess();
        var header = this.chess.header();
        var year = header.Date.split(".")[0];
        this.title = header.White + " vs " + header.Black + " (" + year + ")";
        $("#game-title").append(this.title);

        this.startChess();
    }

    /**
     * Cambia la pantalla de elección de partida al visor tras elegir una partida.
     * @this ChessViewer
     * @memberof ChessViewer
     * @param event
     */
    function on_gameSelection(event) {
        var t = event.currentTarget;
        var file = this.folder_games + $(t).attr('id') + ".pgn";
        $.get(file, get_pgn.bind(this), 'text');
        $("#div-home").hide();
        $("#div-detail").show().addClass("show");
    }

    /**
     * Coloca el tablero al turno correspondiente al elemento de la lista al que se ha hecho clic.
     * @this ChessViewer
     * @memberof ChessViewer
     * @param event
     */
    function on_listClick (event) {
        var t = event.currentTarget;
        var id = $(t).attr('id');
        id = id.split("-")[1];
        this.setChess(id);
    }

    /**
     * Función llamada cuando se ha terminado de cargar los assets. Permite elegir juegos.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function chess3d_ready () {
        $("#btn-loading").fadeOut();
        $("#btn-dropdown").delay(400).fadeIn();
        //this.startChess();
    }

    /**
     * Cuando se hace clic en el botón de play, cambia a botón de pausa. Inicia la reproducción de la partida.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnPlayClick () {
        $('#btn-play').hide();
        $('#btn-pause').show();
        $('#btn-next').prop('disabled', true);
        $('#btn-previous').prop('disabled', true);
        this.resumeChess();
    }

    /**
     * Cuando se hace clic en el botón de pausa, cambia al botón de play. Pausa la partida.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnPauseClick () {
        $('#btn-play').show();
        $('#btn-pause').hide();
        $('#btn-next').prop('disabled', false);
        $('#btn-previous').prop('disabled', false);
        this.pauseChess();
    }

    /**
     * Aumenta la velocidad de la partida al hacer clic en el botón
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnIncreaseSpeed () {
        if(this.speed &lt;= 5500){
            this.setSpeed(this.speed + 500);
            $('#btn-incSpeed').prop('disabled', false);
            $('#btn-decSpeed').prop('disabled', false);
        }
        else $('#btn-incSpeed').prop('disabled', true);
        console.log("speed: " + this.speed);
    }

    /**
     * Disminuye la velocidad de la partida al hacer clic en el botón
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnDecreaseSpeed () {
        if(this.speed >= 1500){
            this.setSpeed(this.speed - 500);
            $('#btn-decSpeed').prop('disabled', false);
            $('#btn-incSpeed').prop('disabled', false);
        }
        else $('#btn-decSpeed').prop('disabled', true);
        console.log("speed: " + this.speed);
    }

    /**
     * Al hacer clic en el botón, va al turno anterior.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnPrevious () {
        this.previousMove();
    }

    /**
     * Al hacer clic en el botón, va al turno siguiente.
     * @this ChessViewer
     * @memberof ChessViewer
     */
    function on_btnNext () {
        this.nextMove();
    }

    var initial_state = {
        data: {
            from: undefined,
            to: undefined,
            color: undefined,
            flags: undefined,
            moves: undefined,
            captured: undefined,
            promotion: undefined
        },

        a1: "white_rook1",
        a2: "white_pawn1",
        a3: null,
        a4: null,
        a5: null,
        a6: null,
        a7: "black_pawn1",
        a8: "black_rook1",

        b1: "white_knight1",
        b2: "white_pawn2",
        b3: null,
        b4: null,
        b5: null,
        b6: null,
        b7: "black_pawn2",
        b8: "black_knight1",

        c1: "white_bishop1",
        c2: "white_pawn3",
        c3: null,
        c4: null,
        c5: null,
        c6: null,
        c7: "black_pawn3",
        c8: "black_bishop1",

        d1: "white_queen",
        d2: "white_pawn4",
        d3: null,
        d4: null,
        d5: null,
        d6: null,
        d7: "black_pawn4",
        d8: "black_queen",

        e1: "white_king",
        e2: "white_pawn5",
        e3: null,
        e4: null,
        e5: null,
        e6: null,
        e7: "black_pawn5",
        e8: "black_king",

        f1: "white_bishop2",
        f2: "white_pawn6",
        f3: null,
        f4: null,
        f5: null,
        f6: null,
        f7: "black_pawn6",
        f8: "black_bishop2",

        g1: "white_knight2",
        g2: "white_pawn7",
        g3: null,
        g4: null,
        g5: null,
        g6: null,
        g7: "black_pawn7",
        g8: "black_knight2",

        h1: "white_rook2",
        h2: "white_pawn8",
        h3: null,
        h4: null,
        h5: null,
        h6: null,
        h7: "black_pawn8",
        h8: "black_rook2"
    };


    function clone(object) {
        return jQuery.extend({}, object);
    }

})(window);</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.1</a> on Sat Jun 13 2015 16:59:57 GMT+0200 (Hora de verano romance) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
